/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("insertfile",function(e){var t=this,n="insertfile",r=e.undef(t.allowFileUpload,!0),i=e.undef(t.allowFileManager,!1),s=e.undef(t.formatUploadUrl,!0),o=e.undef(t.uploadJson,t.basePath+"php/upload_json.php"),u=e.undef(t.extraFileUploadParams,{}),a=e.undef(t.filePostName,"imgFile"),f=t.lang(n+".");t.plugin.fileDialog=function(l){var c=e.undef(l.fileUrl,"http://"),h=e.undef(l.fileTitle,""),p=l.clickFn,d=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keUrl" style="width:60px;">'+f.url+"</label>",'<input type="text" id="keUrl" name="url" class="ke-input-text" style="width:160px;" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+f.upload+'" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+f.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="keTitle" style="width:60px;">'+f.title+"</label>",'<input type="text" id="keTitle" class="ke-input-text" name="title" value="" style="width:160px;" /></div>',"</div>","</form>","</div>"].join(""),v=t.createDialog({name:n,width:450,title:t.lang(n),body:d,yesBtn:{name:t.lang("yes"),click:function(n){var r=e.trim(g.val()),i=b.val();if(r=="http://"||e.invalidUrl(r)){alert(t.lang("invalidUrl")),g[0].focus();return}e.trim(i)===""&&(i=r),p.call(t,r,i)}}}),m=v.div,g=e('[name="url"]',m),y=e('[name="viewServer"]',m),b=e('[name="title"]',m);if(r){var w=e.uploadbutton({button:e(".ke-upload-button",m)[0],fieldName:a,url:e.addParam(o,"dir=file"),extraParams:u,afterUpload:function(r){v.hideLoading();if(r.error===0){var i=r.url;s&&(i=e.formatUrl(i,"absolute")),g.val(i),t.afterUpload&&t.afterUpload.call(t,i,r,n),alert(t.lang("uploadSuccess"))}else alert(r.message)},afterError:function(e){v.hideLoading(),t.errorDialog(e)}});w.fileBox.change(function(e){v.showLoading(t.lang("uploadLoading")),w.submit()})}else e(".ke-upload-button",m).hide();i?y.click(function(n){t.loadPlugin("filemanager",function(){t.plugin.filemanagerDialog({viewType:"LIST",dirName:"file",clickFn:function(n,r){t.dialogs.length>1&&(e('[name="url"]',m).val(n),t.afterSelectFile&&t.afterSelectFile.call(t,n),t.hideDialog())}})})}):y.hide(),g.val(c),b.val(h),g[0].focus(),g[0].select()},t.clickToolbar(n,function(){t.plugin.fileDialog({clickFn:function(e,n){var r='<a href="'+e+'" data-ke-src="'+e+'" target="_blank">'+n+"</a>";t.insertHtml(r).hideDialog().focus()}})})});