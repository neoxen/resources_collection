/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("table",function(e){function s(e,t){t=t.toUpperCase(),e.css("background-color",t),e.css("color",t==="#000000"?"#FFFFFF":"#000000"),e.html(t)}function u(n,r){function i(){e.each(o,function(){this.remove()}),o=[],e(document).unbind("click,mousedown",i),n.unbind("click,mousedown",i)}r.bind("click,mousedown",function(e){e.stopPropagation()}),r.click(function(r){i();var u=e(this),a=u.pos(),f=e.colorpicker({x:a.x,y:a.y+u.height(),z:811214,selectedColor:e(this).html(),colors:t.colorTable,noColor:t.lang("noColor"),shadowMode:t.shadowMode,click:function(e){s(u,e),i()}});o.push(f),e(document).bind("click,mousedown",i),n.bind("click,mousedown",i)})}function a(e,t,n){var r=0;for(var i=0,s=t.cells.length;i<s;i++){if(t.cells[i]==n)break;r+=t.cells[i].rowSpan-1}return n.cellIndex-r}var t=this,n="table",r=t.lang(n+"."),i="ke-zeroborder",o=[];t.plugin.table={prop:function(o){var a=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+r.cells+"</label>",r.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',r.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+r.size+"</label>",r.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select> &nbsp; ",r.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+r.space+"</label>",r.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',r.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+r.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+r.alignDefault+"</option>",'<option value="left">'+r.alignLeft+"</option>",'<option value="center">'+r.alignCenter+"</option>",'<option value="right">'+r.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+r.border+"</label>",r.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',r.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+r.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),f=t.createDialog({name:n,width:500,title:t.lang(n),body:a,beforeRemove:function(){E.unbind()},yesBtn:{name:t.lang("yes"),click:function(n){var r=c.val(),s=h.val(),o=p.val(),u=d.val(),a=v.val(),f=m.val(),l=g.val(),x=y.val(),T=b.val(),N=w.val(),C=e(E[0]).html()||"",k=e(E[1]).html()||"";if(r==0||!/^\d+$/.test(r)){alert(t.lang("invalidRows")),c[0].focus();return}if(s==0||!/^\d+$/.test(s)){alert(t.lang("invalidRows")),h[0].focus();return}if(!/^\d*$/.test(o)){alert(t.lang("invalidWidth")),p[0].focus();return}if(!/^\d*$/.test(u)){alert(t.lang("invalidHeight")),d[0].focus();return}if(!/^\d*$/.test(l)){alert(t.lang("invalidPadding")),g[0].focus();return}if(!/^\d*$/.test(x)){alert(t.lang("invalidSpacing")),y[0].focus();return}if(!/^\d*$/.test(N)){alert(t.lang("invalidBorder")),w[0].focus();return}if(S){o!==""?S.width(o+a):S.css("width",""),S[0].width!==undefined&&S.removeAttr("width"),u!==""?S.height(u+f):S.css("height",""),S[0].height!==undefined&&S.removeAttr("height"),S.css("background-color",k),S[0].bgColor!==undefined&&S.removeAttr("bgColor"),l!==""?S[0].cellPadding=l:S.removeAttr("cellPadding"),x!==""?S[0].cellSpacing=x:S.removeAttr("cellSpacing"),T!==""?S[0].align=T:S.removeAttr("align"),N!==""?S.attr("border",N):S.removeAttr("border"),N===""||N==="0"?S.addClass(i):S.removeClass(i),C!==""?S.attr("borderColor",C):S.removeAttr("borderColor"),t.hideDialog().focus();return}var L="";o!==""&&(L+="width:"+o+a+";"),u!==""&&(L+="height:"+u+f+";"),k!==""&&(L+="background-color:"+k+";");var A="<table";L!==""&&(A+=' style="'+L+'"'),l!==""&&(A+=' cellpadding="'+l+'"'),x!==""&&(A+=' cellspacing="'+x+'"'),T!==""&&(A+=' align="'+T+'"'),N!==""&&(A+=' border="'+N+'"');if(N===""||N==="0")A+=' class="'+i+'"';C!==""&&(A+=' bordercolor="'+C+'"'),A+=">";for(var O=0;O<r;O++){A+="<tr>";for(var M=0;M<s;M++)A+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";A+="</tr>"}A+="</table>",e.IE||(A+="<br />"),t.insertHtml(A),t.select().hideDialog().focus(),t.addBookmark()}}}),l=f.div,c=e('[name="rows"]',l).val(3),h=e('[name="cols"]',l).val(2),p=e('[name="width"]',l).val(100),d=e('[name="height"]',l),v=e('[name="widthType"]',l),m=e('[name="heightType"]',l),g=e('[name="padding"]',l).val(2),y=e('[name="spacing"]',l).val(0),b=e('[name="align"]',l),w=e('[name="border"]',l).val(1),E=e(".ke-input-color",l);u(l,E.eq(0)),u(l,E.eq(1)),s(E.eq(0),"#000000"),s(E.eq(1),""),c[0].focus(),c[0].select();var S;if(o)return;S=t.plugin.getSelectedTable();if(S){c.val(S[0].rows.length),h.val(S[0].rows.length>0?S[0].rows[0].cells.length:0),c.attr("disabled",!0),h.attr("disabled",!0);var x,T=S[0].style.width||S[0].width,N=S[0].style.height||S[0].height;T!==undefined&&(x=/^(\d+)((?:px|%)*)$/.exec(T))?(p.val(x[1]),v.val(x[2])):p.val(""),N!==undefined&&(x=/^(\d+)((?:px|%)*)$/.exec(N))&&(d.val(x[1]),m.val(x[2])),g.val(S[0].cellPadding||""),y.val(S[0].cellSpacing||""),b.val(S[0].align||""),w.val(S[0].border===undefined?"":S[0].border),s(E.eq(0),e.toHex(S.attr("borderColor")||"")),s(E.eq(1),e.toHex(S[0].style.backgroundColor||S[0].bgColor||"")),p[0].focus(),p[0].select()}},cellprop:function(){var i=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+r.size+"</label>",r.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select> &nbsp; ",r.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+r.align+"</label>",r.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+r.alignDefault+"</option>",'<option value="left">'+r.alignLeft+"</option>",'<option value="center">'+r.alignCenter+"</option>",'<option value="right">'+r.alignRight+"</option>","</select> ",r.verticalAlign+' <select name="verticalAlign">','<option value="">'+r.alignDefault+"</option>",'<option value="top">'+r.alignTop+"</option>",'<option value="middle">'+r.alignMiddle+"</option>",'<option value="bottom">'+r.alignBottom+"</option>",'<option value="baseline">'+r.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+r.border+"</label>",r.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',r.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+r.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),o=t.createDialog({name:n,width:500,title:t.lang("tablecell"),body:i,beforeRemove:function(){y.unbind()},yesBtn:{name:t.lang("yes"),click:function(n){var r=f.val(),i=l.val(),s=c.val(),o=h.val(),u=p.val(),a=d.val(),w=v.val(),E=m.val(),S=g.val(),x=e(y[0]).html()||"",T=e(y[1]).html()||"";if(!/^\d*$/.test(r)){alert(t.lang("invalidWidth")),f[0].focus();return}if(!/^\d*$/.test(i)){alert(t.lang("invalidHeight")),l[0].focus();return}if(!/^\d*$/.test(S)){alert(t.lang("invalidBorder")),g[0].focus();return}b.css({width:r!==""?r+s:"",height:i!==""?i+o:"","background-color":T,"text-align":w,"vertical-align":E,"border-width":S,"border-style":S!==""?"solid":"","border-color":x}),t.hideDialog().focus(),t.addBookmark()}}}),a=o.div,f=e('[name="width"]',a).val(100),l=e('[name="height"]',a),c=e('[name="widthType"]',a),h=e('[name="heightType"]',a),p=e('[name="padding"]',a).val(2),d=e('[name="spacing"]',a).val(0),v=e('[name="textAlign"]',a),m=e('[name="verticalAlign"]',a),g=e('[name="border"]',a).val(1),y=e(".ke-input-color",a);u(a,y.eq(0)),u(a,y.eq(1)),s(y.eq(0),"#000000"),s(y.eq(1),""),f[0].focus(),f[0].select();var b=t.plugin.getSelectedCell(),w,E=b[0].style.width||b[0].width||"",S=b[0].style.height||b[0].height||"";(w=/^(\d+)((?:px|%)*)$/.exec(E))?(f.val(w[1]),c.val(w[2])):f.val("");if(w=/^(\d+)((?:px|%)*)$/.exec(S))l.val(w[1]),h.val(w[2]);v.val(b[0].style.textAlign||""),m.val(b[0].style.verticalAlign||"");var x=b[0].style.borderWidth||"";x&&(x=parseInt(x)),g.val(x),s(y.eq(0),e.toHex(b[0].style.borderColor||"")),s(y.eq(1),e.toHex(b[0].style.backgroundColor||"")),f[0].focus(),f[0].select()},insert:function(){this.prop(!0)},"delete":function(){var e=t.plugin.getSelectedTable();t.cmd.range.setStartBefore(e[0]).collapse(!0),t.cmd.select(),e.remove(),t.addBookmark()},colinsert:function(n){var r=t.plugin.getSelectedTable()[0],i=t.plugin.getSelectedRow()[0],s=t.plugin.getSelectedCell()[0],o=s.cellIndex+n;o+=r.rows[0].cells.length-i.cells.length;for(var u=0,f=r.rows.length;u<f;u++){var l=r.rows[u],c=l.insertCell(o);c.innerHTML=e.IE?"":"<br />",o=a(r,l,c)}t.cmd.range.selectNodeContents(s).collapse(!0),t.cmd.select(),t.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(n){var r=t.plugin.getSelectedTable()[0],i=t.plugin.getSelectedRow()[0],s=t.plugin.getSelectedCell()[0],o=i.rowIndex;n===1&&(o=i.rowIndex+(s.rowSpan-1)+n);var u=r.insertRow(o);for(var a=0,f=i.cells.length;a<f;a++){i.cells[a].rowSpan>1&&(f-=i.cells[a].rowSpan-1);var l=u.insertCell(a);n===1&&i.cells[a].colSpan>1&&(l.colSpan=i.cells[a].colSpan),l.innerHTML=e.IE?"":"<br />"}for(var c=o;c>=0;c--){var h=r.rows[c].cells;if(h.length>a){for(var p=s.cellIndex;p>=0;p--)h[p].rowSpan>1&&(h[p].rowSpan+=1);break}}t.cmd.range.selectNodeContents(s).collapse(!0),t.cmd.select(),t.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=t.plugin.getSelectedTable()[0],n=t.plugin.getSelectedRow()[0],r=t.plugin.getSelectedCell()[0],i=n.rowIndex,s=i+r.rowSpan,o=e.rows[s];if(e.rows.length<=s)return;var u=a(e,n,r);if(o.cells.length<=u)return;var f=o.cells[u];if(r.colSpan!==f.colSpan)return;r.rowSpan+=f.rowSpan,o.deleteCell(u),t.cmd.range.selectNodeContents(r).collapse(!0),t.cmd.select(),t.addBookmark()},colmerge:function(){var e=t.plugin.getSelectedTable()[0],n=t.plugin.getSelectedRow()[0],r=t.plugin.getSelectedCell()[0],i=n.rowIndex,s=r.cellIndex,o=s+1;if(n.cells.length<=o)return;var u=n.cells[o];if(r.rowSpan!==u.rowSpan)return;r.colSpan+=u.colSpan,n.deleteCell(o),t.cmd.range.selectNodeContents(r).collapse(!0),t.cmd.select(),t.addBookmark()},rowsplit:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=r.rowIndex;if(i.rowSpan===1)return;var o=a(n,r,i);for(var u=1,f=i.rowSpan;u<f;u++){var l=n.rows[s+u],c=l.insertCell(o);i.colSpan>1&&(c.colSpan=i.colSpan),c.innerHTML=e.IE?"":"<br />",o=a(n,l,c)}e(i).removeAttr("rowSpan"),t.cmd.range.selectNodeContents(i).collapse(!0),t.cmd.select(),t.addBookmark()},colsplit:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=i.cellIndex;if(i.colSpan===1)return;for(var o=1,u=i.colSpan;o<u;o++){var a=r.insertCell(s+o);i.rowSpan>1&&(a.rowSpan=i.rowSpan),a.innerHTML=e.IE?"":"<br />"}e(i).removeAttr("colSpan"),t.cmd.range.selectNodeContents(i).collapse(!0),t.cmd.select(),t.addBookmark()},coldelete:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=i.cellIndex;for(var o=0,u=n.rows.length;o<u;o++){var a=n.rows[o],f=a.cells[s];f.colSpan>1?(f.colSpan-=1,f.colSpan===1&&e(f).removeAttr("colSpan")):a.deleteCell(s),f.rowSpan>1&&(o+=f.rowSpan-1)}r.cells.length===0?(t.cmd.range.setStartBefore(n).collapse(!0),t.cmd.select(),e(n).remove()):t.cmd.selection(!0),t.addBookmark()},rowdelete:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=r.rowIndex;for(var o=i.rowSpan-1;o>=0;o--)n.deleteRow(s+o);n.rows.length===0?(t.cmd.range.setStartBefore(n).collapse(!0),t.cmd.select(),e(n).remove()):t.cmd.selection(!0),t.addBookmark()}},t.clickToolbar(n,t.plugin.table.prop)});