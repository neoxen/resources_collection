/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("media",function(e){var t=this,n="media",r=t.lang(n+"."),i=e.undef(t.allowMediaUpload,!0),s=e.undef(t.allowFileManager,!1),o=e.undef(t.formatUploadUrl,!0),u=e.undef(t.extraFileUploadParams,{}),a=e.undef(t.filePostName,"imgFile"),f=e.undef(t.uploadJson,t.basePath+"php/upload_json.php");t.plugin.media={edit:function(){var l=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keUrl" style="width:60px;">'+r.url+"</label>",'<input class="ke-input-text" type="text" id="keUrl" name="url" value="" style="width:160px;" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+r.upload+'" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+r.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:60px;">'+r.width+"</label>",'<input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="550" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keHeight" style="width:60px;">'+r.height+"</label>",'<input type="text" id="keHeight" class="ke-input-text ke-input-number" name="height" value="400" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAutostart">'+r.autostart+"</label>",'<input type="checkbox" id="keAutostart" name="autostart" value="" /> ',"</div>","</div>"].join(""),c=t.createDialog({name:n,width:450,height:230,title:t.lang(n),body:l,yesBtn:{name:t.lang("yes"),click:function(n){var r=e.trim(p.val()),i=v.val(),s=m.val();if(r=="http://"||e.invalidUrl(r)){alert(t.lang("invalidUrl")),p[0].focus();return}if(!/^\d*$/.test(i)){alert(t.lang("invalidWidth")),v[0].focus();return}if(!/^\d*$/.test(s)){alert(t.lang("invalidHeight")),m[0].focus();return}var o=e.mediaImg(t.themesPath+"common/blank.gif",{src:r,type:e.mediaType(r),width:i,height:s,autostart:g[0].checked?"true":"false",loop:"true"});t.insertHtml(o).hideDialog().focus()}}}),h=c.div,p=e('[name="url"]',h),d=e('[name="viewServer"]',h),v=e('[name="width"]',h),m=e('[name="height"]',h),g=e('[name="autostart"]',h);p.val("http://");if(i){var y=e.uploadbutton({button:e(".ke-upload-button",h)[0],fieldName:a,extraParams:u,url:e.addParam(f,"dir=media"),afterUpload:function(r){c.hideLoading();if(r.error===0){var i=r.url;o&&(i=e.formatUrl(i,"absolute")),p.val(i),t.afterUpload&&t.afterUpload.call(t,i,r,n),alert(t.lang("uploadSuccess"))}else alert(r.message)},afterError:function(e){c.hideLoading(),t.errorDialog(e)}});y.fileBox.change(function(e){c.showLoading(t.lang("uploadLoading")),y.submit()})}else e(".ke-upload-button",h).hide();s?d.click(function(n){t.loadPlugin("filemanager",function(){t.plugin.filemanagerDialog({viewType:"LIST",dirName:"media",clickFn:function(n,r){t.dialogs.length>1&&(e('[name="url"]',h).val(n),t.afterSelectFile&&t.afterSelectFile.call(t,n),t.hideDialog())}})})}):d.hide();var b=t.plugin.getSelectedMedia();if(b){var w=e.mediaAttrs(b.attr("data-ke-tag"));p.val(w.src),v.val(e.removeUnit(b.css("width"))||w.width||0),m.val(e.removeUnit(b.css("height"))||w.height||0),g[0].checked=w.autostart==="true"}p[0].focus(),p[0].select()},"delete":function(){t.plugin.getSelectedMedia().remove()}},t.clickToolbar(n,t.plugin.media.edit)});